è¿™æ˜¯ä¸€ç¯‡ä¸ºæ‚¨å®šåˆ¶çš„æŠ€æœ¯åšå®¢æ–‡ç« ã€‚æ‚¨å¯ä»¥ç›´æ¥å°†å…¶å‘å¸ƒåœ¨æ‚¨çš„æŠ€æœ¯ä¸“æ ã€GitHub Readme æˆ–å†…éƒ¨æ–‡æ¡£ä¸­ã€‚

---

# ä»åƒç´ åˆ°ç‰©ç†ä¸–ç•Œï¼šç¬¬ä¸€äººç§°è§†è§‰ä¸­çš„ 2D å…³é”®ç‚¹ 3D åŒ–æ–¹æ¡ˆå…¨è§£æ

åœ¨å…·èº«æ™ºèƒ½ï¼ˆEmbodied AIï¼‰å’Œæœºå™¨äººæ“ä½œï¼ˆå¦‚ EMMA é¡¹ç›®ï¼‰ä¸­ï¼Œæ•°æ®é‡‡é›†æ˜¯è‡³å…³é‡è¦çš„ä¸€ç¯ã€‚å½“æˆ‘ä»¬ä½©æˆ´ Project Aria ç­‰è®¾å¤‡é‡‡é›†â€œå¼€é—¨â€ã€â€œæŠ“å–â€ç­‰æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€åªèƒ½åœ¨æŸä¸€å¸§å›¾åƒä¸Šæ‰‹åŠ¨æ ‡æ³¨ 2D å…³é”®ç‚¹ï¼ˆä¾‹å¦‚é—¨æŠŠæ‰‹çš„ä¸­å¿ƒï¼‰ã€‚ç„¶è€Œï¼Œæœºå™¨äººéœ€è¦çš„æ˜¯ç‰©ç†ä¸–ç•Œä¸­çš„ **3D åæ ‡**ã€‚

å¦‚ä½•ä»å•ç›®è§†é¢‘çš„æŸä¸€å¸§ 2D ç‚¹ï¼Œç²¾ç¡®æ¢å¤å‡ºçœŸå®çš„ 3D åæ ‡ï¼Ÿæœ¬æ–‡å°†æ·±å…¥å‰–æä¸‰ç§ä¸»æµæŠ€æœ¯è·¯çº¿ï¼Œä»åŸç†ã€æ•°å­¦æ¨å¯¼åˆ°ä»£ç å®ç°ï¼Œä¸ºæ‚¨æä¾›ä¸€ä»½ç»ˆææŒ‡å—ã€‚

---

## è·¯çº¿æ¦‚è§ˆ

æˆ‘ä»¬é¢ä¸´ä¸‰ç§ä¸»è¦çš„æŠ€æœ¯é€‰æ‹©ï¼š

1.  **è·¯çº¿ Cï¼šç¨€ç–ç‚¹äº‘æŸ¥æ‰¾ (Sparse Point Cloud Lookup)** - åˆ©ç”¨ SLAM å»ºå›¾ç»“æœã€‚
2.  **è·¯çº¿ Bï¼šå•ç›®æ·±åº¦ä¼°è®¡ (Monocular Depth Estimation)** - åˆ©ç”¨æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼ˆDepth Pro, Metric3Dï¼‰ã€‚
3.  **è·¯çº¿ Aï¼šå¤šè§†è§’å‡ ä½•ä¸‰è§’åŒ– (Multi-View Triangulation)** - åˆ©ç”¨å…‰æµ/CoTracker + å‡ ä½•è§£ç®—ã€‚**ï¼ˆæœ¬æ–‡æ¨èæ–¹æ¡ˆï¼‰**

---

## è·¯çº¿ Cï¼šç¨€ç–ç‚¹äº‘æŸ¥æ‰¾ (Aria Semi-dense Point Cloud)

è¿™æ˜¯æœ€ç›´æ¥çš„æ–¹æ³•ã€‚Project Aria çš„ MPS (Machine Perception Services) ä¼šç”ŸæˆåŠç¨ å¯†ç‚¹äº‘ã€‚

### åŸç†
ç›´æ¥å°† 2D åƒç´ æŠ•å½±åˆ° 3D ç©ºé—´ï¼Œå¯»æ‰¾å°„çº¿ä¸Šè·ç¦»æœ€è¿‘çš„ SLAM åœ°å›¾ç‚¹ã€‚
### ä¼˜ç¼ºç‚¹
*   âœ… **ä¼˜ç‚¹**ï¼šè®¡ç®—é›¶æˆæœ¬ï¼Œç›´æ¥æŸ¥è¡¨ã€‚
*   âŒ **ç¼ºç‚¹**ï¼š**ç¨€ç–æ€§æ˜¯è‡´å‘½ä¼¤**ã€‚é—¨æŠŠæ‰‹é€šå¸¸æ˜¯é‡‘å±ã€åå…‰ä¸”çº¹ç†å°‘çš„ç‰©ä½“ï¼ŒSLAM å¾ˆéš¾åœ¨ä¸Šé¢ç”Ÿæˆç‰¹å¾ç‚¹ã€‚ç›´æ¥æŸ¥æ‰¾å¾€å¾€ä¼šç©¿é€æŠŠæ‰‹ï¼ŒæŸ¥åˆ°èƒŒæ™¯ï¼ˆé—¨æ¿ï¼‰çš„æ·±åº¦ï¼Œå¯¼è‡´ä¸¥é‡çš„**æ¼‚ç§»**ã€‚

---

## è·¯çº¿ Bï¼šå•ç›®æ·±åº¦ä¼°è®¡ (Depth Pro / Metric3D)

åˆ©ç”¨åœ¨æµ·é‡æ•°æ®ä¸Šè®­ç»ƒçš„æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œç›´æ¥é¢„æµ‹å•å¸§å›¾åƒçš„æ·±åº¦å›¾ã€‚

### åŸç†
è¾“å…¥ RGB å›¾åƒï¼Œç¥ç»ç½‘ç»œè¾“å‡ºæ¯ä¸ªåƒç´ çš„ç»å¯¹æ·±åº¦å€¼ $Z$ã€‚
$$ \mathbf{X}_{3d} = Z \cdot K^{-1} \cdot [u, v, 1]^T $$

### ä¼˜ç¼ºç‚¹
*   âœ… **ä¼˜ç‚¹**ï¼šç¨ å¯†ï¼Œæ¯ä¸ªåƒç´ éƒ½æœ‰æ·±åº¦ã€‚
*   âŒ **ç¼ºç‚¹**ï¼š
    1.  **å°ºåº¦ä¸ç¡®å®šæ€§ (Scale Ambiguity)**ï¼šå³ä½¿æ˜¯ Metric æ¨¡å‹ï¼Œå¯¹å¾®å°ç‰©ä½“ï¼ˆå¦‚æŠŠæ‰‹ï¼‰çš„ç»å¯¹å°ºå¯¸ä¼°è®¡å¾€å¾€æœ‰ 10%-20% çš„è¯¯å·®ã€‚
    2.  **è¾¹ç¼˜æ•ˆåº” (Edge Fattening)**ï¼šæŠŠæ‰‹è¾¹ç¼˜çš„æ·±åº¦å¾€å¾€ä¸èƒŒæ™¯æ¨¡ç³Šåœ¨ä¸€èµ·ï¼Œå¯¼è‡´å…³é”®ç‚¹â€œæ‚¬æµ®â€ã€‚
    3.  **ç¼ºä¹ç‰©ç†çº¦æŸ**ï¼šçº¯ç²¹åŸºäºè§†è§‰çº¹ç†çš„â€œçŒœæµ‹â€ï¼Œè€Œéå‡ ä½•è®¡ç®—ã€‚

---

## è·¯çº¿ Aï¼šå¤šè§†è§’å‡ ä½•ä¸‰è§’åŒ– (Multi-View Triangulation) â€”â€” ğŸ‘‘ é»„é‡‘æ ‡å‡†
è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ã€‚é€šè¿‡â€œå¤šè§†è§’ä¸‰è§’åŒ–â€ï¼ˆMulti-View Triangulationï¼‰æ¥æ¢å¤ 3D åæ ‡ï¼Œæ˜¯è®¡ç®—æœºè§†è§‰ï¼ˆSLAM/SfMï¼‰ä¸­æœ€åŸºç¡€ä¹Ÿæœ€æ ¸å¿ƒçš„ç®—æ³•ä¹‹ä¸€ã€‚

ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä¼šç”¨æœ€é€šä¿—çš„è¯­è¨€ï¼Œé…åˆæ•°å­¦å…¬å¼å’Œä»£ç å¯¹åº”å…³ç³»ï¼Œå¸¦ä½ ä¸€æ­¥æ­¥æ¨å¯¼å‡ºæ¥ã€‚

---

### ç¬¬ä¸€éƒ¨åˆ†ï¼šç›´è§‚ç†è§£â€”â€”â€œæ¿€å…‰ç¬”â€åŸç†

æƒ³è±¡ä½ åœ¨ä¸€ä¸ªæ¼†é»‘çš„æˆ¿é—´é‡Œï¼š

1.  **å•è§†è§’ï¼ˆä¸€å¼ ç…§ç‰‡ï¼‰**ï¼š
    ä½ æ‰‹é‡Œæ‹¿ç€ä¸€åªæ¿€å…‰ç¬”ï¼ˆä»£è¡¨ç›¸æœºï¼‰ï¼Œç«™åœ¨ä½ç½® Aï¼Œå…‰ç‚¹æ‰“åœ¨äº†å¢™ä¸Šçš„ä¸€ä¸ªç‚¹ï¼ˆåƒç´ ï¼‰ã€‚
    *   **é—®é¢˜**ï¼šä½ åªçŸ¥é“å…‰çº¿æ˜¯ä»ä½ æ‰‹é‡Œå°„å‡ºå»çš„ï¼Œæ–¹å‘ç¡®å®šçš„ã€‚ä½†ä½ ä¸çŸ¥é“è¿™ä¸ªå…‰ç‚¹ç¦»ä½ æœ‰å¤šè¿œã€‚å®ƒå¯èƒ½åœ¨ 1 ç±³å¤„çš„æ¤…å­ä¸Šï¼Œä¹Ÿå¯èƒ½åœ¨ 10 ç±³å¤„çš„å¢™ä¸Šã€‚
    *   **ç»“è®º**ï¼šä¸€å¼ ç…§ç‰‡ä¸¢å¤±äº†æ·±åº¦ä¿¡æ¯ï¼Œ3D ç‚¹å˜æˆäº† 2D ç‚¹ï¼Œ**ä¸€æ¡å°„çº¿ä¸Šçš„æ‰€æœ‰ç‚¹éƒ½ä¼šæŠ•å½±æˆåŒä¸€ä¸ªåƒç´ **ã€‚

2.  **å¤šè§†è§’ï¼ˆä¸¤å¼ åŠä»¥ä¸Šç…§ç‰‡ï¼‰**ï¼š
    ç°åœ¨ï¼Œä½ ä¿æŒæ¿€å…‰ç¬”æŒ‡ç€é‚£ä¸ªç‚¹ä¸åŠ¨ï¼Œä½ è‡ªå·±èµ°åˆ°ä½ç½® Bï¼ˆæˆ–è€…è®©ä½ çš„æœ‹å‹åœ¨ä½ç½® B ä¹ŸæŒ‡ç€é‚£ä¸ªç‚¹ï¼‰ã€‚
    *   ä»ä½ç½® A å°„å‡ºä¸€æ¡å°„çº¿ã€‚
    *   ä»ä½ç½® B å°„å‡ºä¸€æ¡å°„çº¿ã€‚
    *   **ç»“è®º**ï¼šè¿™ä¸¤æ¡å°„çº¿åœ¨ç©ºé—´ä¸­å”¯ä¸€çš„äº¤ç‚¹ï¼Œå°±æ˜¯é‚£ä¸ªç‰©ä½“çš„çœŸå®çš„ **3D ä½ç½®**ã€‚

è¿™å°±æ˜¯**ä¸‰è§’åŒ–**ï¼šåˆ©ç”¨å¤šä¸ªè§†è§’ä¸‹çš„è§‚æµ‹ï¼ˆ2D åƒç´ åæ ‡ï¼‰å’Œå·²çŸ¥çš„ç›¸æœºä½ç½®ï¼ˆPoseï¼‰ï¼Œè®¡ç®—å‡ºå°„çº¿çš„äº¤ç‚¹ï¼ˆ3D åæ ‡ï¼‰ã€‚

---

### ç¬¬äºŒéƒ¨åˆ†ï¼šæ•°å­¦æ¨å¯¼â€”â€”ä»åƒç´ åˆ°ä¸–ç•Œ

æˆ‘ä»¬éœ€è¦å»ºç«‹ä¸€ä¸ªæ•°å­¦æ¨¡å‹ï¼Œæè¿°â€œä¸–ç•Œä¸Šçš„ 3D ç‚¹â€æ˜¯æ€ä¹ˆå˜æˆâ€œç…§ç‰‡ä¸Šçš„ 2D åƒç´ â€çš„ã€‚è¿™å°±æ˜¯**é’ˆå­”ç›¸æœºæ¨¡å‹**ã€‚

#### 1. æ ¸å¿ƒå…¬å¼
å‡è®¾ä¸–ç•Œåæ ‡ç³»ä¸­æœ‰ä¸€ä¸ªç‚¹ $\mathbf{X}_w = [X, Y, Z, 1]^T$ï¼ˆé½æ¬¡åæ ‡ï¼‰ï¼Œå®ƒæŠ•å½±åˆ°å›¾åƒä¸Šå˜æˆäº†åƒç´  $\mathbf{x} = [u, v, 1]^T$ã€‚

å…¬å¼å¦‚ä¸‹ï¼š
$$ s \cdot \mathbf{x} = K \cdot [R | t] \cdot \mathbf{X}_w $$

è¿™é‡Œæ¯ä¸ªç¬¦å·çš„å«ä¹‰ï¼š
*   $s$ï¼š**æ·±åº¦å› å­**ï¼ˆScale factorï¼‰ã€‚å› ä¸ºæŠ•å½±ä¸¢å¤±äº†æ·±åº¦ï¼Œæˆ‘ä»¬éœ€è¦è¿™ä¸ªæœªçŸ¥æ•°æ¥è¡¨ç¤ºç¼©æ”¾æ¯”ä¾‹ã€‚
*   $\mathbf{x}$ï¼š**åƒç´ åæ ‡** $[u, v, 1]^T$ã€‚è¿™æ˜¯æˆ‘ä»¬åœ¨å›¾ç‰‡ä¸Šé€‰çš„ç‚¹ï¼Œæ˜¯**å·²çŸ¥é‡**ã€‚
*   $K$ï¼š**å†…å‚çŸ©é˜µ**ï¼ˆIntrinsicsï¼‰ã€‚æè¿°ç›¸æœºçš„ç„¦è·å’Œä¸­å¿ƒï¼Œæ˜¯**å·²çŸ¥é‡**ã€‚
*   $[R | t]$ï¼š**å¤–å‚çŸ©é˜µ**ï¼ˆExtrinsicsï¼‰ã€‚ä¹Ÿå°±æ˜¯ $T_{w2c}$ï¼ˆWorld to Cameraï¼‰ï¼Œæè¿°ç›¸æœºåœ¨å“ªé‡Œã€æœå‘å“ªé‡Œï¼Œç”± Aria æä¾›ï¼Œæ˜¯**å·²çŸ¥é‡**ã€‚
*   $\mathbf{X}_w$ï¼š**ä¸–ç•Œåæ ‡** $[X, Y, Z, 1]^T$ã€‚è¿™æ˜¯æˆ‘ä»¬**æƒ³è¦æ±‚è§£çš„æœªçŸ¥é‡**ã€‚

#### 2. ç®€åŒ–å…¬å¼ï¼ˆæŠ•å½±çŸ©é˜µ Pï¼‰
æˆ‘ä»¬å¯ä»¥æŠŠå†…å‚ $K$ å’Œå¤–å‚ $[R|t]$ ä¹˜èµ·æ¥ï¼Œåˆæˆä¸ºä¸€ä¸ª $3 \times 4$ çš„**æŠ•å½±çŸ©é˜µ** $P$ï¼š
$$ P = K \cdot [R | t] $$

é‚£ä¹ˆæ ¸å¿ƒå…¬å¼å˜æˆäº†ï¼š
$$ s \begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \begin{bmatrix} P_{00} & P_{01} & P_{02} & P_{03} \\ P_{10} & P_{11} & P_{12} & P_{13} \\ P_{20} & P_{21} & P_{22} & P_{23} \end{bmatrix} \begin{bmatrix} X \\ Y \\ Z \\ 1 \end{bmatrix} $$

æˆ–è€…å†™æˆå‘é‡å½¢å¼ï¼ˆ$P_0, P_1, P_2$ ä»£è¡¨çŸ©é˜µ $P$ çš„ç¬¬ 1ã€2ã€3 è¡Œï¼‰ï¼š
$$
\begin{cases}
s \cdot u = P_0 \cdot \mathbf{X}_w \\
s \cdot v = P_1 \cdot \mathbf{X}_w \\
s \cdot 1 = P_2 \cdot \mathbf{X}_w
\end{cases}
$$

#### 3. æ¶ˆå»æœªçŸ¥æ•° $s$
æˆ‘ä»¬éœ€è¦è§£ $\mathbf{X}_w$ï¼Œä½† $s$ æ˜¯æœªçŸ¥çš„ä¸”å¯¹æ¯ä¸ªç‚¹éƒ½ä¸ä¸€æ ·ï¼Œå¾ˆéº»çƒ¦ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ç¬¬ 3 ä¸ªç­‰å¼ï¼ˆ$s = P_2 \cdot \mathbf{X}_w$ï¼‰ä»£å…¥å‰ä¸¤ä¸ªç­‰å¼ï¼ŒæŠŠ $s$ æ¶ˆæ‰ï¼š

å¯¹äº $u$ï¼š
$$ u = \frac{P_0 \cdot \mathbf{X}_w}{P_2 \cdot \mathbf{X}_w} \implies u (P_2 \cdot \mathbf{X}_w) - (P_0 \cdot \mathbf{X}_w) = 0 $$

å¯¹äº $v$ï¼š
$$ v = \frac{P_1 \cdot \mathbf{X}_w}{P_2 \cdot \mathbf{X}_w} \implies v (P_2 \cdot \mathbf{X}_w) - (P_1 \cdot \mathbf{X}_w) = 0 $$

#### 4. æ„å»ºæ–¹ç¨‹ç»„ $A\mathbf{X} = 0$
ç°åœ¨ï¼Œå¯¹äº**è¿™ä¸€ä¸ªè§†è§’**ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸¤ä¸ªå…³äº $\mathbf{X}_w$ çš„çº¿æ€§æ–¹ç¨‹ï¼š
$$
\begin{cases}
(u P_2 - P_0) \cdot \mathbf{X}_w = 0 \\
(v P_2 - P_1) \cdot \mathbf{X}_w = 0
\end{cases}
$$

ä½†æ˜¯ $\mathbf{X}_w$ æœ‰ 3 ä¸ªæœªçŸ¥æ•°ï¼ˆX, Y, Zï¼‰ï¼Œä¸¤ä¸ªæ–¹ç¨‹è§£ä¸å‡ºæ¥ã€‚
è¿™å°±éœ€è¦**å¤šè§†è§’**äº†ï¼

å‡è®¾æˆ‘ä»¬æœ‰ $N$ ä¸ªè§†è§’ï¼ˆè„šæœ¬é‡Œç”¨äº† 30 å¸§å·¦å³ï¼‰ï¼Œæ¯ä¸ªè§†è§’éƒ½èƒ½æä¾› 2 ä¸ªæ–¹ç¨‹ã€‚æˆ‘ä»¬æŠŠå®ƒä»¬å…¨éƒ¨å †å èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå·¨å¤§çš„çŸ©é˜µæ–¹ç¨‹ç»„ï¼š

$$
A \mathbf{X}_w = 0
$$

å…¶ä¸­çŸ©é˜µ $A$ çš„å½¢çŠ¶æ˜¯ $(2N) \times 4$ã€‚å¦‚æœ $N=30$ï¼Œè¿™å°±æ˜¯ä¸€ä¸ª $60 \times 4$ çš„çŸ©é˜µã€‚
$$
A = \begin{bmatrix}
u^{(1)} P_2^{(1)} - P_0^{(1)} \\
v^{(1)} P_2^{(1)} - P_1^{(1)} \\
\vdots \\
u^{(N)} P_2^{(N)} - P_0^{(N)} \\
v^{(N)} P_2^{(N)} - P_1^{(N)}
\end{bmatrix}
$$

#### 5. æ±‚è§£ (SVD åˆ†è§£)
ç†æƒ³æƒ…å†µä¸‹ï¼Œå°„å‡ºæ¥çš„å…‰çº¿å®Œç¾äº¤äºä¸€ç‚¹ï¼Œæ–¹ç¨‹æœ‰å”¯ä¸€è§£ã€‚
ä½†ç°å®ä¸­ï¼Œç”±äºåƒç´ ä¹Ÿæ˜¯ç¦»æ•£çš„ã€å…‰æµè¿½è¸ªæœ‰è¯¯å·®ã€ç›¸æœºä½å§¿æœ‰å¾®å°è¯¯å·®ï¼Œè¿™å‡ åæ¡çº¿åœ¨ 3D ç©ºé—´é‡Œ**ä¸ä¼šå®Œç¾ç›¸äº¤**ï¼ˆå®ƒä»¬ä¼šäº’ç›¸æ“¦è‚©è€Œè¿‡ï¼‰ã€‚

æ‰€ä»¥æˆ‘ä»¬æ±‚çš„æ˜¯**æœ€å°äºŒä¹˜è§£**ï¼ˆLeast Squares Solutionï¼‰ï¼šæ‰¾åˆ°ä¸€ä¸ªç‚¹ $\mathbf{X}$ï¼Œä½¿å¾—å®ƒç¦»æ‰€æœ‰å°„çº¿çš„è·ç¦»ä¹‹å’Œæœ€å°ã€‚ä¹Ÿå°±æ˜¯è®© $||A\mathbf{X}||$ æœ€å°ã€‚

æ•°å­¦ä¸Šï¼Œæ±‚è§£ $A\mathbf{X}=0$ çš„éé›¶è§£ï¼Œç­‰ä»·äºå¯¹çŸ©é˜µ $A$ è¿›è¡Œ **SVDï¼ˆå¥‡å¼‚å€¼åˆ†è§£ï¼‰**ï¼š
$$ A = U \Sigma V^T $$
**è§£ $\mathbf{X}_w$ å°±æ˜¯ $V^T$ çš„æœ€åä¸€è¡Œï¼ˆå¯¹åº”æœ€å°å¥‡å¼‚å€¼çš„ç‰¹å¾å‘é‡ï¼‰ã€‚**

æœ€åï¼ŒæŠŠæ±‚å‡ºçš„ $[X, Y, Z, W]$ é™¤ä»¥ $W$ï¼Œå½’ä¸€åŒ–å¾—åˆ°æœ€ç»ˆçš„ 3D åæ ‡ $[X/W, Y/W, Z/W]$ã€‚


### 3. è¿½è¸ªå™¨å¯¹æ¯”ï¼šLK å…‰æµ vs. CoTracker

è¦å®ç°ä¸‰è§’åŒ–ï¼Œæ ¸å¿ƒå‰ææ˜¯**è¦åœ¨å‡ åå¸§é‡Œè·Ÿä½è¿™ä¸ªç‚¹**ã€‚

*   **OpenCV Lucas-Kanade (LK) å…‰æµ**ï¼š
    *   **åŸç†**ï¼šåŸºäºäº®åº¦æ’å®šå‡è®¾ï¼Œè®¡ç®—å±€éƒ¨æ¢¯åº¦ã€‚
    *   **ç¼ºç‚¹**ï¼š**ä¸æŠ—é®æŒ¡**ã€‚å¦‚æœæ‰‹æŒ¡ä½äº†æŠŠæ‰‹ï¼ŒLK ä¼šè·Ÿä¸¢æˆ–å¸é™„åœ¨æ‰‹ä¸Šã€‚**æ¼‚ç§»ç´¯ç§¯**ä¸¥é‡ã€‚
    *   **é€‚ç”¨**ï¼šæçŸ­æ—¶é—´ã€æ— é®æŒ¡ã€çº¹ç†ä¸°å¯Œçš„åœºæ™¯ã€‚

*   **CoTracker v3 (Meta/Facebook)**ï¼š
    *   **åŸç†**ï¼šåŸºäº Transformer çš„é•¿æ—¶åºè¿½è¸ªã€‚
    *   **ä¼˜ç‚¹**ï¼š**æŠ—é®æŒ¡ (Occlusion Handling)**ã€‚èƒ½è¾“å‡º `visibility mask`ï¼Œè‡ªåŠ¨å‰”é™¤è¢«æ‰‹é®æŒ¡çš„å¸§ã€‚**é•¿æ—¶ä¸€è‡´æ€§**ï¼Œåˆ©ç”¨æ»‘åŠ¨çª—å£æœºåˆ¶ï¼Œç²¾åº¦è¿œè¶… LKã€‚
    *   **ç»“è®º**ï¼š**æ„å»ºæ•°æ®é›†è¯·åŠ¡å¿…ä½¿ç”¨ CoTrackerã€‚**

---

## ä»£ç å®ç°è¯¦è§£ (Python)

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„å®ç°ï¼Œé›†æˆäº† CoTrackerã€LKï¼ˆå¸¦ Forward-Backward Checkï¼‰å’Œ SVD ä¸‰è§’åŒ–ï¼Œå¹¶å¤„ç†äº† Aria å›¾åƒæ—‹è½¬çš„åæ ‡ç³»é—®é¢˜ã€‚

```python
import numpy as np
import cv2
import torch
import open3d as o3d
from scipy.optimize import least_squares

# ==========================================
# 1. å‡ ä½•ä¿®æ­£æ¨¡å— (å¤„ç† Aria ç«–å±æ—‹è½¬é—®é¢˜)
# ==========================================
class GeometryCorrector:
    """
    Aria è¾“å‡ºçš„ RGB æ˜¯æ—‹è½¬è¿‡ 90 åº¦(ç«–å±)çš„ï¼Œä½†å†…å‚ K å’Œ Pose æ˜¯åŸºäºåŸå§‹ Sensor (æ¨ªå±)çš„ã€‚
    å¿…é¡»åœ¨ Raw ç©ºé—´è¿›è¡Œå‡ ä½•è®¡ç®—ã€‚
    """
    @staticmethod
    def rotate_point_vis_to_raw(u_vis, v_vis, vis_w):
        """å¯è§†åŒ–åæ ‡ -> åŸå§‹ä¼ æ„Ÿå™¨åæ ‡"""
        u_raw = v_vis
        v_raw = vis_w - 1 - u_vis
        return float(u_raw), float(v_raw)

    @staticmethod
    def get_raw_gray_frame(dataset, idx):
        """è·å–æœªæ—‹è½¬çš„ç°åº¦å›¾ (ç”¨äº LK å…‰æµ)"""
        img_vis = dataset[idx].cam.rgb # BGR, Rotated
        # é€†æ—¶é’ˆæ—‹è½¬ 90 åº¦è¿˜åŸå› Raw Landscape
        img_raw = np.rot90(img_vis, k=1) 
        return cv2.cvtColor(img_raw, cv2.COLOR_BGR2GRAY)

# ==========================================
# 2. è¿½è¸ªæ¨¡å— (LK + FB Check / CoTracker)
# ==========================================
class FeatureTracker:
    def __init__(self, dataset, device='cuda'):
        self.dataset = dataset
        self.device = device
        # å°è¯•åŠ è½½ CoTracker
        try:
            from cotracker.predictor import CoTrackerPredictor
            self.cotracker = CoTrackerPredictor(checkpoint="./checkpoints/cotracker2.pth").to(device)
            self.has_cotracker = True
        except:
            self.has_cotracker = False
            print("Warning: CoTracker not found, using LK flow.")

    def track_lk_with_fb_check(self, start_idx, pt_raw, win_size=30, err_thresh=1.0):
        """
        å¸¦ Forward-Backward Check çš„ LK å…‰æµè¿½è¸ª
        åŸç†ï¼šä» A è¿½åˆ° Bï¼Œå†ä» B è¿½å› A'ã€‚å¦‚æœ |A - A'| > thresholdï¼Œåˆ™è®¤ä¸ºè¿½è¸ªå¤±è´¥ã€‚
        """
        tracks = {start_idx: pt_raw}
        
        # å®šä¹‰ LK å‚æ•°
        lk_params = dict(winSize=(21, 21), maxLevel=3, criteria=(cv2.TERM_CRITERIA_EPS | cv2.TERM_CRITERIA_COUNT, 30, 0.01))
        
        # å‘å‰è¿½è¸ª (Forward)
        prev_gray = GeometryCorrector.get_raw_gray_frame(self.dataset, start_idx)
        prev_pt = np.array([pt_raw], dtype=np.float32)
        
        for i in range(start_idx + 1, min(len(self.dataset), start_idx + win_size)):
            curr_gray = GeometryCorrector.get_raw_gray_frame(self.dataset, i)
            
            # 1. Forward: prev -> curr
            p1, st, err = cv2.calcOpticalFlowPyrLK(prev_gray, curr_gray, prev_pt, None, **lk_params)
            # 2. Backward: curr -> prev
            p0r, st_inv, err_inv = cv2.calcOpticalFlowPyrLK(curr_gray, prev_gray, p1, None, **lk_params)
            
            # 3. Check Distance
            dist = np.linalg.norm(prev_pt - p0r).flatten()[0]
            
            # åªæœ‰å½“è¿½è¸ªæˆåŠŸä¸” FB è¯¯å·®å°äºé˜ˆå€¼æ—¶æ‰ä¿ç•™
            if st[0][0] == 1 and dist < err_thresh:
                # è¾¹ç•Œæ£€æŸ¥
                x, y = p1[0].ravel()
                h, w = curr_gray.shape
                if 0 <= x < w and 0 <= y < h:
                    tracks[i] = (x, y)
                    prev_gray = curr_gray
                    prev_pt = p1
                    continue
            
            break # ä¸€æ—¦å¤±è´¥ï¼Œåœæ­¢è¯¥æ–¹å‘è¿½è¸ª
            
        # (æ­¤å¤„çœç•¥å‘åè¿½è¸ª Backward çš„ä»£ç ï¼Œé€»è¾‘åŒä¸Šï¼Œæ–¹å‘ç›¸å)
        
        return tracks

    def track_cotracker(self, frame_idx, pt_raw, win_size=30):
        """ä½¿ç”¨ CoTracker è¿›è¡Œé•¿æ—¶åºè¿½è¸ª"""
        # ... (æ•°æ®å‡†å¤‡: éœ€è¦å°† Raw å›¾åƒå †å æˆ (1, T, 3, H, W) Tensor) ...
        # ... (Query æ„å»º: (1, 1, 3) -> [t, x, y]) ...
        # ... (Inference: pred_tracks, pred_vis = model(video, queries)) ...
        
        # ä¼ªä»£ç é€»è¾‘ï¼š
        tracks = {}
        # éå†è¾“å‡ºï¼Œåˆ©ç”¨ pred_vis > 0.5 è¿‡æ»¤é®æŒ¡å¸§
        # for t in range(T):
        #    if pred_vis[0, t, 0] > 0.5:
        #        tracks[abs_idx] = pred_tracks[0, t, 0]
        return tracks

# ==========================================
# 3. ä¸‰è§’åŒ–æ¨¡å— (SVD)
# ==========================================
class MultiViewTriangulator:
    def __init__(self, dataset):
        self.dataset = dataset

    def solve(self, tracks):
        """
        SVD ä¸‰è§’åŒ–æ±‚è§£ Ax = 0
        tracks: {frame_idx: (u_raw, v_raw)}
        """
        if len(tracks) < 5: return None # å¸§æ•°å¤ªå°‘ä¸ç¨³
        
        A = []
        for idx, (u, v) in tracks.items():
            s = self.dataset[idx]
            K = s.cam.k      # Raw Intrinsics
            T_c2w = s.cam.c2w
            T_w2c = np.linalg.inv(T_c2w)
            
            # æŠ•å½±çŸ©é˜µ P = K * [R|t] (3x4)
            P = K @ T_w2c[:3, :] 
            
            # æ„é€ æ–¹ç¨‹: u = (P0*X)/(P2*X), v = (P1*X)/(P2*X)
            # å˜å½¢ä¸º: u*P2*X - P0*X = 0
            A.append(u * P[2] - P[0])
            A.append(v * P[2] - P[1])
            
        A = np.array(A)
        
        # SVD
        u, s, vh = np.linalg.svd(A)
        p4 = vh[-1] # æœ€å°å¥‡å¼‚å€¼å¯¹åº”çš„ç‰¹å¾å‘é‡
        p3 = p4[:3] / p4[3] # é½æ¬¡åæ ‡å½’ä¸€åŒ–
        
        return p3
```

---

## çœŸå®ç‰©ç†éƒ¨ç½²ï¼šé»„é‡‘æ³•åˆ™

ç®—æ³•å†å¼ºï¼Œå¦‚æœè¾“å…¥æ•°æ®æ²¡æœ‰åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä¹Ÿç®—ä¸å‡†ã€‚åœ¨ä½©æˆ´çœ¼é•œé‡‡é›†æ•°æ®æ—¶ï¼Œè¯·åŠ¡å¿…éµå®ˆ **â€œå¹³ç§»è§†å·®â€ (Translational Parallax)** æ³•åˆ™ã€‚

### 1. ä¸ºä»€ä¹ˆéœ€è¦åŠ¨ï¼Ÿ
ä¸‰è§’åŒ–é çš„æ˜¯å°„çº¿çš„**äº¤å‰**ã€‚å¦‚æœä½ ç«™åœ¨åŸåœ°ä¸åŠ¨åªè½¬å¤´ï¼ˆçº¯æ—‹è½¬ï¼‰ï¼Œæ‰€æœ‰å…‰å¿ƒä½ç½®å‡ ä¹é‡åˆï¼Œå°„çº¿æ˜¯å¹³è¡Œçš„ï¼Œæ— æ³•è§£ç®—æ·±åº¦ï¼ˆæ•°å­¦ä¸Šè¡¨ç°ä¸ºçŸ©é˜µ $A$ ç§©äºï¼‰ã€‚

### 2. æ€ä¹ˆåŠ¨ï¼Ÿ
åœ¨ä¼¸æ‰‹å»æŠ“æŠŠæ‰‹ä¹‹å‰çš„ **0.5 - 1 ç§’**ï¼š
*   **åŠ¨ä½œ**ï¼šå¤´éƒ¨/ä¸ŠåŠèº«å¾®å¾®**å·¦å³å¹³ç§»**æˆ–**ä¾§èº«**ï¼ˆå¹…åº¦ 15-20cm å³å¯ï¼‰ã€‚
*   **ç›®çš„**ï¼šäººä¸ºåˆ¶é€ ä¸€ä¸ª Baselineï¼ˆåŸºçº¿ï¼‰ï¼Œè®©ç›¸æœºä»ä¸åŒä½ç½®è§‚å¯ŸæŠŠæ‰‹ã€‚

### 3. æ³¨æ„äº‹é¡¹
*   **é¿å…é®æŒ¡**ï¼šåœ¨ç§»åŠ¨è§‚å¯ŸæœŸé—´ï¼Œæ‰‹ä¸è¦æŒ¡ä½æŠŠæ‰‹ã€‚
*   **é¿å…æ¨¡ç³Š**ï¼šåŠ¨ä½œè¦ç¨³ï¼Œé˜²æ­¢ Motion Blur å¹²æ‰°å…‰æµè¿½è¸ªã€‚
*   **é˜²æ­¢è¿‡æ›**ï¼šé‡‘å±æŠŠæ‰‹å®¹æ˜“åå…‰ï¼Œå°½é‡ä¿è¯ç¯å¢ƒå…‰ç…§å‡åŒ€ï¼Œé¿å…å…‰æµè¿½è¸ªåˆ°â€œè™šå‡çš„â€é«˜å…‰ç‚¹ä¸Šã€‚

---

## æ€»ç»“

è¿™æ˜¯ä¸€ä¸ªå…³äºæ·±åº¦ä¼°è®¡æŠ€æœ¯é€‰å‹ï¼ˆGeometry vs. Learning-basedï¼‰çš„æ·±åˆ»é—®é¢˜ã€‚

### è·¯çº¿ B (æ·±åº¦æ¨¡å‹) çš„ Pipeline æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿ

å¦‚æœä½ æƒ³å°è¯• Depth Pro / Metric3Dï¼Œæµç¨‹å¦‚ä¸‹ï¼š

1.  **è¾“å…¥**ï¼šä½ é€‰å®šçš„ä¸€å¸§å›¾åƒ $I$ å’Œç‚¹å‡»åæ ‡ $(u, v)$ã€‚
2.  **æ¨ç†**ï¼šå°† $I$ é€å…¥æ·±åº¦æ¨¡å‹ï¼Œå¾—åˆ°ä¸€å¼ ç¨ å¯†çš„æ·±åº¦å›¾ $D$ã€‚
    *   **æ³¨æ„**ï¼šDepth Anything è¾“å‡ºçš„æ˜¯ç›¸å¯¹æ·±åº¦ï¼Œæ— æ³•ç›´æ¥ç”¨ã€‚å¿…é¡»ç”¨ **Depth Pro** æˆ– **Metric3D v2** è¿™ç§æ”¯æŒ **Metric Depth (ç»å¯¹å°ºåº¦)** çš„æ¨¡å‹ã€‚
3.  **è¯»å€¼**ï¼šç›´æ¥è¯»å–æ·±åº¦å›¾åœ¨è¯¥åæ ‡çš„å€¼ $d = D[v, u]$ã€‚
4.  **åæŠ•å½±**ï¼š
    $$ \mathbf{X}_{cam} = d \cdot K^{-1} \cdot [u, v, 1]^T $$
    $$ \mathbf{X}_{world} = T_{c2w} \cdot \mathbf{X}_{cam} $$

**ä¸ºä»€ä¹ˆæˆ‘ä¸æ¨èè·¯çº¿ B (æ·±åº¦æ¨¡å‹)ï¼Ÿ**

1.  **å°ºåº¦ä¸å‡† (Scale Ambiguity)**ï¼š
    è™½ç„¶ Metric3D å·ç§°èƒ½å‡ºç»å¯¹å°ºåº¦ï¼Œä½†å®ƒä¸»è¦æ˜¯é’ˆå¯¹â€œæˆ¿é—´ã€åœ°æ¿ã€å¢™å£â€è¿™ç§å¤§åœºæ™¯è®­ç»ƒçš„ã€‚å¯¹äºâ€œè·ç¦»ç›¸æœº 30cm çš„ä¸€ä¸ªåå…‰å°é‡‘å±æŠŠæ‰‹â€ï¼Œå®ƒçš„ç»å¯¹æ·±åº¦é¢„æµ‹å¾€å¾€ä¼šæœ‰ 10%-20% çš„è¯¯å·®ã€‚è€Œåœ¨æœºæ¢°è‡‚æŠ“å–ä¸­ï¼Œ2cm çš„è¯¯å·®å¯èƒ½å°±å¯¼è‡´æŠ“ç©ºã€‚
2.  **è¾¹ç¼˜æ•ˆåº” (Edge Fattening)**ï¼š
    æ·±åº¦æ¨¡å‹ç”Ÿæˆçš„æ·±åº¦å›¾åœ¨ç‰©ä½“è¾¹ç¼˜å¾€å¾€æ˜¯æ¨¡ç³Šçš„ï¼ˆæŠŠæ‰‹è¾¹ç¼˜çš„æ·±åº¦å¯èƒ½å’ŒèƒŒæ™¯é—¨æ¿çš„æ·±åº¦ç³Šåœ¨ä¸€èµ·ï¼‰ã€‚ä½ ç‚¹åœ¨æŠŠæ‰‹è¾¹ç¼˜ï¼Œè¯»å‡ºæ¥çš„æ·±åº¦å¯èƒ½æ˜¯ä¸€ä¸ªâ€œåŠæŠŠæ‰‹åŠé—¨â€çš„å¹³å‡å€¼ï¼Œå¯¼è‡´ 3D ç‚¹æ‚¬æµ®åœ¨åŠç©ºã€‚
3.  **å¤šä½™è®¡ç®—**ï¼š
    ä½ åªéœ€è¦æ±‚ 3 ä¸ªç‚¹çš„æ·±åº¦ï¼Œå´è¦è®¡ç®—å…¨å›¾ 200 ä¸‡ä¸ªåƒç´ çš„æ·±åº¦ï¼Œæ€é¸¡ç”¨ç‰›åˆ€ã€‚

---

### ç»“è®ºä¸æ¨è

**æˆ‘æœ€æ¨èçš„æ–¹æ³•ï¼šè·¯çº¿ A (CoTracker v3 + å¤šè§†è§’ä¸‰è§’åŒ–)**

**ç†ç”±ï¼š**
1.  **ç‰©ç†çœŸç†**ï¼šAria çš„ Pose æ˜¯ç»è¿‡æå…¶ä¸¥è‹›æ ¡å‡†çš„çœŸå®ç‰©ç†é‡ã€‚åˆ©ç”¨å®ƒç®—å‡ºæ¥çš„æ·±åº¦æ˜¯**çœŸç†**ï¼Œè€Œä¸æ˜¯æ¨¡å‹â€œçŒœâ€å‡ºæ¥çš„ç»éªŒå€¼ã€‚
2.  **èšç„¦ç›®æ ‡**ï¼šæˆ‘ä»¬åªå…³å¿ƒæŠŠæ‰‹ã€‚CoTracker å¯ä»¥æ­»æ­»å’¬ä½æŠŠæ‰‹ä¸Šçš„ç‰¹å¾ç‚¹ï¼Œåˆ©ç”¨å‡ åå¸§çš„ä¿¡æ¯æ¥â€œå»å™ªâ€ï¼Œç²¾åº¦è¿œè¶…å•å¸§æ·±åº¦ä¼°è®¡ã€‚
3.  **é²æ£’æ€§**ï¼šå³ä½¿æŠŠæ‰‹åå…‰ã€çº¹ç†å°‘ï¼Œåªè¦æœ‰ä¸€ä¸ªè§’åº¦èƒ½çœ‹æ¸…ï¼Œä¸‰è§’åŒ–å°±èƒ½è§£å‡ºæ¥ã€‚è€Œæ·±åº¦æ¨¡å‹é‡åˆ°åå…‰ç‰©ä½“ç»å¸¸ä¼šé¢„æµ‹å‡ºé»‘æ´æˆ–æ— é™è¿œã€‚


é’ˆå¯¹â€œä»å•ç›®è§†é¢‘ä¸­æ¢å¤ Handle 3D Keypointsâ€è¿™ä¸ªä»»åŠ¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§ä¸»è¦è·¯çº¿ï¼š

| ç‰¹æ€§ | **è·¯çº¿ A: å‡ ä½•ä¸‰è§’åŒ– (CoTracker + Triangulation)** | **è·¯çº¿ B: å•ç›®æ·±åº¦ä¼°è®¡ (Depth Pro / Depth Anything)** | **è·¯çº¿ C: ç¨€ç–ç‚¹äº‘æŸ¥æ‰¾ (Aria Semi-dense PointCloud)** |
| :--- | :--- | :--- | :--- |
| **æ ¸å¿ƒåŸç†** | **å¤šè§†è§’å‡ ä½•**ã€‚åˆ©ç”¨å…‰æµçš„ä¸€è‡´æ€§å’Œç›¸æœºçš„ç²¾ç¡®ä½ç§»æ¥â€œç®—â€å‡ºæ·±åº¦ã€‚ | **æ·±åº¦å­¦ä¹ å…ˆéªŒ**ã€‚æ¨¡å‹â€œçœ‹â€è¿‡å‡ äº¿å¼ å›¾ï¼Œå®ƒå‡­ç»éªŒâ€œçŒœâ€å‡ºè¿™ä¸ªåƒç´ ç¦»å¤šè¿œã€‚ | **SLAMå»ºå›¾**ã€‚åˆ©ç”¨ä¹‹å‰è·‘SLAMæ—¶ç•™ä¸‹çš„è·¯æ ‡ç‚¹ã€‚ |
| **ç²¾åº¦ä¸Šé™** | **æé«˜ (æ¯«ç±³çº§)**ã€‚åªè¦ Pose å‡†ã€è¿½è¸ªç¨³ï¼Œè¿™æ˜¯ç‰©ç†ä¸Šæœ€å‡†çš„æ–¹æ³•ã€‚ | **ä¸­ç­‰ (å˜ç±³/åˆ†ç±³çº§)**ã€‚å­˜åœ¨å°ºåº¦æ¼‚ç§» (Scale Drift) å’Œå½¢å˜é—®é¢˜ã€‚ | **ä½ (å–å†³äºç¨€ç–åº¦)**ã€‚å®¹æ˜“æŸ¥ä¸åˆ°ç‚¹æˆ–æŸ¥é”™å±‚ã€‚ |
| **ç»å¯¹å°ºåº¦** | **å®Œç¾ç»å¯¹å°ºåº¦**ã€‚å› ä¸º Aria çš„ Pose æ˜¯çœŸå®ç±³åˆ¶å•ä½ï¼Œç®—å‡ºæ¥çš„è·ç¦»å°±æ˜¯çœŸå®çš„ç±³ã€‚ | **æœªçŸ¥/ä¸å‡†**ã€‚Depth Anything è¾“å‡ºçš„æ˜¯ç›¸å¯¹æ·±åº¦ (0-1)ã€‚Depth Pro/Metric3D è™½ç„¶å£°ç§° Metricï¼Œä½†åœ¨å¾®è·ä¸‹è¯¯å·®ä»å¤§ã€‚ | **å®Œç¾ç»å¯¹å°ºåº¦**ã€‚åŒ Aã€‚ |
| **æŠ—é®æŒ¡æ€§** | **å¼º** (é…åˆ CoTracker)ã€‚å¯ä»¥å‰”é™¤é®æŒ¡å¸§ã€‚ | **å¼±**ã€‚å¦‚æœæ‰‹æŒ¡ä½æŠŠæ‰‹ï¼Œæ·±åº¦å›¾é‚£ä¸€å—å°±æ˜¯æ‰‹çš„æ·±åº¦ï¼Œæ²¡æ³•é€è¿‡æ‰‹çœ‹æŠŠæ‰‹ã€‚ | **æ— **ã€‚ |
| **ç¨³å®šæ€§** | **æç¨³**ã€‚å¤šå¸§çº¦æŸã€‚ | **æŠ–åŠ¨**ã€‚å•å¸§é¢„æµ‹æ—¶ï¼Œç›¸é‚»ä¸¤å¸§çš„æ·±åº¦å›¾å¯èƒ½ä¼šé—ªçƒ (Flicker)ã€‚ | **ç¨³å®šä½†ç¨€ç–**ã€‚ |
| **è®¡ç®—æˆæœ¬** | **é«˜** (éœ€è·‘å…‰æµæ¨¡å‹)ã€‚ | **æé«˜** (éœ€è·‘å¤§æ·±åº¦æ¨¡å‹)ã€‚ | **æä½** (ç›´æ¥æŸ¥è¡¨)ã€‚ |
| **ç»å¯¹å°ºåº¦** | âœ… å®Œç¾ (ä¾èµ– Pose) | âŒ å¾€å¾€æœ‰å°ºåº¦æ¼‚ç§» | âœ… å®Œç¾ |
| **é²æ£’æ€§** | å¼º (éœ€çº¹ç†/å…‰æµ) | ä¸€èˆ¬ (æ€•è¾¹ç¼˜/é€æ˜) | å·® (æ€•ç¨€ç–) |
| **æ¨èåœºæ™¯** | **Ground Truth åˆ¶ä½œ** | å®æ—¶é¿éšœ/å¤§åœºæ™¯ | ç²—ç•¥å®šä½ |
---
å¯¹äº**é—¨æŠŠæ‰‹å…³é”®ç‚¹æå–**è¿™ç±»å¯¹ç²¾åº¦è¦æ±‚æé«˜çš„ä»»åŠ¡ï¼Œ**è·¯çº¿ A (CoTracker + SVD ä¸‰è§’åŒ–)** ç»“åˆè§„èŒƒçš„æ•°æ®é‡‡é›†åŠ¨ä½œï¼Œæ˜¯ç›®å‰å·¥ä¸šç•Œå’Œå­¦æœ¯ç•Œçš„**æœ€ä¼˜è§£**ã€‚